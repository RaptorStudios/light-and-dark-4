<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>L4W Mapper</title>
<meta name='viewport' content='width=device-width, initial-scale=0.7, user-scalable=yes'/>

<!-- Disable cache (only for developement stage) -->
<meta http-equiv='cache-control' content='no-cache'>
<meta http-equiv='expires' content='0'>
<meta http-equiv='pragma' content='no-cache'>

<script type="text/javascript" src="js/l4w.js"></script>
<script type="text/javascript" src="lib/jquery.js"></script>
<script type="text/javascript" src="lib/jstree.js"></script>
<link rel="stylesheet" type="text/css" href="style/jstree/style.min.css">
<link rel="stylesheet" type="text/css" href="style/l4w.css">

<script type='text/javascript'>
	function start() {	
		$('#mapPanel').jstree({
			'core' : {
				"animation" : 0,
				'data' : {
					"url" : "data/map/maps.json",
				    "dataType" : "json"
				},
				"check_callback" : true,
			},
			"multiple" : false,
			"plugins" : [
				"dnd",
				"contextmenu"
			],
			"themes" : {
		    	"dots" : false
		    }
		});
		
		$('#mapPanel').on("changed.jstree", function (e, data) {
		    $('#extraPanel').show();
		    var node = data.instance.get_selected(true)[0];
        	$('#mapSizeW').val(node.data.w);
        	$('#mapSizeH').val(node.data.h);
        	$('#tiles').val(node.data.tile);
		});
		
		Mapper.start(canvas);
		
		loadTiles();
	}
	
	function changeSize() {
		var node = $('#mapPanel').jstree(true).get_selected(true)[0];
    	node.data.w = $('#mapSizeW').val();
    	node.data.h = $('#mapSizeH').val();
    	
    	var updatedData = $('#mapPanel').jstree(true).get_json('#', {flat:true});
    	$.ajax({
    		url: "edit/maps",
    		type: 'post',
    		contentType: 'application/json',
    		data: JSON.stringify(updatedData),
    		success: function(result){
        		console.log("Maps updated");
    		}
    	});
	}
	
	function loadTiles() {
		$.getJSON(
			"assets/tileset/tiles.json", 
			function( data ) {
			 	var sel = $("#tiles");
			    for (var i=0; i<data.length; i++) {
			    	sel.append('<option value="' + data[i].name + '">' + data[i].desc + '</option>');
			    }
			}
		);	
	}
	
	function changeTile() {
		var node = $('#mapPanel').jstree(true).get_selected(true)[0];
    	node.data.tile = $('#tiles').val();
    	
    	var updatedData = $('#mapPanel').jstree(true).get_json('#', {flat:true});
    	$.ajax({
    		url: "edit/maps",
    		type: 'post',
    		contentType: 'application/json',
    		data: JSON.stringify(updatedData),
    		success: function(result){
        		console.log("Maps updated");
    		}
    	});
	}
	
</script>

</head>
<body onload="start()">
<div style="float:left;position:relative;margin-left:auto;margin-right:auto;">
	<canvas id="canvas1" width="672" height="512" style="border:1px solid black">
	Your browser does not support HTML5 Canvas!</canvas>
		
	<script type='text/javascript'>
	var canvas = document.getElementById('canvas1');
	var ctx = canvas.getContext('2d');
	ctx.fillStyle='#000000';
	ctx.font='bold 38px Arial';
	ctx.fillText("loading...",10,20);
	</script>
	
	
</div>
<div style="float:right;position:relative;margin-right:0;width:20%">
	<div style="border:1px solid black">
	-<input id="zoom" type="range" min="0" max="3" step="1" value="3">+
	</div>
	<div style="border:1px solid black">
		<table>
		<tr><td><button type="button">A1</button></td><td><button type="button">A2</button></td><td><button type="button">A3</button></td><td><button type="button">A4</button></td></tr>
		<tr><td><button type="button">B1</button></td><td><button type="button">B2</button></td><td><button type="button">B3</button></td><td><button type="button">B4</button></td></tr>
		<tr><td><button type="button">C1</button></td><td><button type="button">C2</button></td><td><button type="button">C3</button></td><td><button type="button">C4</button></td></tr>
		<tr><td><button type="button">D1</button></td><td><button type="button">D2</button></td><td><button type="button">D3</button></td><td><button type="button">D4</button></td></tr>
		</table>
	</div>
	<div style="border:1px solid black">
		<table>
	<tr><td id="mapPanel"></td>
	</table>
	</div>
	<div id="extraPanel" style="display:none;border:1px solid black">
	<table>
	<tr>
		<td>Tile</td>
		<td>
			<select id="tiles" onchange="changeTile()"></select>
		</td>
		<td>
		</td>
	</tr>
	<tr>
		<td>Size</td>
		<td>
			<input id="mapSizeW" type="number" name="width" min="21" max="999" step="1" style="width:3em">
			 x 
			<input id="mapSizeH" type="number" name="width" min="16" max="999" step="1" style="width:3em">
		</td>
		<td>
			<button type="submit" onclick="changeSize();">&#8634;</button>
		</td>
	</tr>
	</div>
</div>
</body>
</html>